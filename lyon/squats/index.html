<!doctype html>
<html>

    <head>
        <title>Squats Archive : </title>

        <meta charset="utf-8">

        <script src="../../static/js/lib/jquery.min.js"></script>
        <script src="../../static/js/lib/marked.min.js"></script>

        <script src="../settings.js"></script>

        <script>

            function writeList(articles){
                $('#page-content').html($('<ul>'));
                for (var i in articles){
                    var fileName = articles[i].name;
                    if (fileName.substr(-3) === '.md'){
                        squatName = fileName.slice(0,-3);
                        $('#page-content ul').append(
                            $('<li>').append(
                                $('<a>',{href:'#'+squatName, text: squatName})
                            )
                        )
                    }
                }
            }

            function writeArticle(md){
                // md to html
                var html = marked(md);
                // Change links from relative to absolute
                var content = $('div').html(html);
                var rawURL = 'https://raw.githubusercontent.com/'+GITHUB_USER+'/'+GITHUB_REPO+'/master/';
                var absolute = /^https?:\/\//i ;
                content.find('img').each(function(){
                    var src = $(this).attr('src') ;
                    if (!absolute.test(src)){
                        $(this).attr('src',rawURL+src);
                    }
                });
                // append
                $('#page-content').append(content);
            }

            src="/me"

            function fetchFail(){
                $('#page-content').text('Sorry, we didn\'t find the squat you\'re looking for !');
            }


            var repoURL = 'https://api.github.com/repos/'+GITHUB_USER+'/'+GITHUB_REPO+'/contents/';

            function fetch(){
                var squat = window.location.hash.substr(1);
                if (squat === ''){
                    // Show the list of described squats
                    $.ajax({
                        type: 'GET',
                        //dataType: 'Text',  //use jsonp data type in order to perform cross domain ajax
                        //crossDomain: true,
                        url: repoURL,
                        success: function (responseData, textStatus, jqXHR) {
                            writeList(responseData);
                        },
                        error: function (responseData, textStatus, errorThrown) {
                           fetchFail();
                        }
                    });
                }else{
                    // Show the description of the required squat
                    var articleURL = repoURL+squat+'.md';
                    $.ajax({
                        type: 'GET',
                        //dataType: 'Text',  //use jsonp data type in order to perform cross domain ajax
                        //crossDomain: true,
                        url: articleURL,
                        success: function (responseData, textStatus, jqXHR) {
                            // To fix ! what about different encodings ?
                            if (responseData.encoding === 'base64'){
                                writeArticle(atob(responseData.content));
                            }
                        },
                        error: function (responseData, textStatus, errorThrown) {
                           fetchFail();
                        }
                    });
                }
            }
            $(window).on('hashchange', fetch);
            fetch();
        </script>

    </head>
        <div id="page-content">
            Loading the page... if it doesn't work, make sure you have javascript enabled.
        </div>
    <body>

    </body>

</html>
